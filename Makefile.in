# @configure_input@
#
# $Id: Makefile.in,v 1.14 2010/04/30 20:25:06 keithmarshall Exp $

PACKAGE_TARNAME = @PACKAGE_TARNAME@
PACKAGE_VERSION = @PACKAGE_VERSION@

# Written by Keith Marshall <keithmarshall@users.sourceforge.net>
# Copyright (C) 2009, 2010, MinGW Project
#
#
# Makefile template for mingw-get
#
#
# This is free software.  Permission is granted to copy, modify and
# redistribute this software, under the provisions of the GNU General
# Public License, Version 3, (or, at your option, any later version),
# as published by the Free Software Foundation; see the file COPYING
# for licensing details.
#
# Note, in particular, that this software is provided "as is", in the
# hope that it may prove useful, but WITHOUT WARRANTY OF ANY KIND; not
# even an implied WARRANTY OF MERCHANTABILITY, nor of FITNESS FOR ANY
# PARTICULAR PURPOSE.  Under no circumstances will the author, or the
# MinGW Project, accept liability for any damages, however caused,
# arising from the use of this software.
#
srcdir = @srcdir@
abs_top_srcdir = @abs_top_srcdir@

DEBUGLEVEL = 0

VPATH = ${srcdir}/src ${srcdir}/src/pkginfo ${srcdir}/tinyxml

CC = @CC@
CFLAGS = @CFLAGS@
CPPFLAGS = @CPPFLAGS@ -D DEBUGLEVEL=$(DEBUGLEVEL) $(INCLUDES)

CXX = @CXX@
CXXFLAGS = $(CFLAGS)

INCLUDES = -I ${srcdir}/src -I ${srcdir}/src/pkginfo -I ${srcdir}/tinyxml

LEX = @LEX@

AR = @AR@
ARFLAGS = @ARFLAGS@

OBJEXT = @OBJEXT@
EXEEXT = @EXEEXT@

LDFLAGS = @LDFLAGS@
LIBS = -Wl,-Bstatic -lz -lbz2 -llzma -Wl,-Bdynamic -lwininet

CORE_DLL_OBJECTS = climain.$(OBJEXT) \
   pkgbind.$(OBJEXT) pkginet.$(OBJEXT) pkgstrm.$(OBJEXT) pkgname.$(OBJEXT) \
   pkgexec.$(OBJEXT) pkgfind.$(OBJEXT) pkginfo.$(OBJEXT) pkgspec.$(OBJEXT) \
   sysroot.$(OBJEXT) pkghash.$(OBJEXT) pkgkeys.$(OBJEXT) pkgdeps.$(OBJEXT) \
   xmlfile.$(OBJEXT) keyword.$(OBJEXT) vercmp.$(OBJEXT)  dmh.$(OBJEXT) \
   mkpath.$(OBJEXT)  pkginst.$(OBJEXT) tarproc.$(OBJEXT) \
   tinyxml.$(OBJEXT) tinyxmlparser.$(OBJEXT) \
   tinystr.$(OBJEXT) tinyxmlerror.$(OBJEXT)

all: pkginfo$(EXEEXT) mingw-get$(EXEEXT) mingw-get-0.dll

pkginfo$(EXEEXT):  driver.$(OBJEXT) pkginfo.$(OBJEXT)
	$(CC) -o $@ $(CFLAGS) $(LDFLAGS) $+

mingw-get$(EXEEXT): clistub.$(OBJEXT) version.$(OBJEXT)
	$(CXX) -o $@ $(CXXFLAGS) $(LDFLAGS) $+

mingw-get-0.dll: $(CORE_DLL_OBJECTS)
	$(CXX) -shared -o $@ $(CXXFLAGS) $(LDFLAGS) $+ $(LIBS)

# Compilation and dependency tracking...
#
DEPFLAGS = -MM -MP -MD
sinclude *.d

%.$(OBJEXT): %.c
	$(CC) $(DEPFLAGS) $(CPPFLAGS) $(CFLAGS) $<
	$(CC) -c $(CPPFLAGS) $(CFLAGS) -o $@ $<

%.$(OBJEXT): %.cpp
	$(CXX) $(DEPFLAGS) $(CPPFLAGS) $(CXXFLAGS) $<
	$(CXX) -c $(CPPFLAGS) $(CXXFLAGS) -o $@ $<

# Installation tools and directory paths...
#
mkinstalldirs = @MKDIR_P@

prefix = @prefix@
exec_prefix = @exec_prefix@
localstatedir = @localstatedir@
libexecdir = @libexecdir@
bindir = @bindir@

PACKAGE_CONFIG_DIR = ${localstatedir}/lib/${PACKAGE_TARNAME}/data

INSTALL = @INSTALL@
INSTALL_DATA = @INSTALL_DATA@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
INSTALL_SCRIPT = @INSTALL_SCRIPT@

STRIP = @STRIP@
LN_S = @LN_S@

# Installation rules...
#
installdirs:
	$(mkinstalldirs) ${bindir}
	$(mkinstalldirs) ${libexecdir}/${PACKAGE_TARNAME}
	$(mkinstalldirs) ${PACKAGE_CONFIG_DIR}

install: installdirs
	$(INSTALL_PROGRAM) pkginfo$(EXEEXT) ${bindir}
	$(INSTALL_PROGRAM) mingw-get$(EXEEXT) ${bindir}
	$(INSTALL_DATA) mingw-get-0.dll ${libexecdir}/${PACKAGE_TARNAME}
	$(INSTALL_DATA) ${srcdir}/xml/profile.xml ${PACKAGE_CONFIG_DIR}

install-strip: install
	$(STRIP) ${bindir}/pkginfo$(EXEEXT)
	$(STRIP) ${bindir}/mingw-get$(EXEEXT)
	$(STRIP) ${libexecdir}/${PACKAGE_TARNAME}/mingw-get-0.dll

# Packaging and distribution...
#
# FIXME: the PACKAGE_DISTVERSION and PACKAGE_ROOTVERSION macro definitions
# and usage (below) will require modification, (most likely with help from
# configure), to accommodate inclusion of the `mingw32' subsystem qualifier,
# when the release status qualifier is dropped from PACKAGE_VERSION.
#
LICENCE_FILES = README COPYING
SRCDIST_FILES = $(LICENCE_FILES) ChangeLog version.c.in \
  configure.ac configure Makefile.in install-sh

SRCDIST_SUBDIRS = src src/pkginfo tinyxml xml

PACKAGE_DISTNAME = $(PACKAGE_TARNAME)-$(PACKAGE_DISTVERSION)
PACKAGE_DISTVERSION = `echo $(PACKAGE_VERSION) | sed 's,-[^0-9],-mingw32&,'`
PACKAGE_ROOTVERSION = `echo $(PACKAGE_VERSION) | sed 's,-[^0-9].*,,'`
PACKAGE_DISTROOT = $(PACKAGE_TARNAME)-$(PACKAGE_ROOTVERSION)

dist: srcdist bindist

bindist: all licdist
	rm -rf staged
	$(MAKE) --no-print-directory prefix=`pwd`/staged install-strip
	cd staged; tar chf - bin/pkginfo$(EXEEXT) | gzip -c > \
	  ../pkginfo-$(PACKAGE_DISTVERSION)-bin.tar.gz
	rm staged/bin/pkginfo$(EXEEXT)
	cd staged; tar chf - * | gzip -c > ../$(PACKAGE_DISTNAME)-bin.tar.gz
	cd staged; zip -r ../$(PACKAGE_DISTNAME)-bin.zip *
	rm -rf staged

licdist:
	rm -rf shared
	$(mkinstalldirs) ./shared/doc/${PACKAGE_TARNAME}
	cd ./shared/doc/${PACKAGE_TARNAME}; for file in $(LICENCE_FILES); \
	  do $(LN_S) ${abs_top_srcdir}/$$file .; done
	tar chf - shared | gzip -c > $(PACKAGE_DISTNAME)-lic.tar.gz
	rm -rf shared

srcdist: pkginfo.c
	rm -rf ${PACKAGE_DISTROOT} && mkdir ${PACKAGE_DISTROOT}
	cd ${PACKAGE_DISTROOT}; for file in $(SRCDIST_FILES); do \
	  $(LN_S) ${abs_top_srcdir}/$$file .; done
	for dir in $(SRCDIST_SUBDIRS); do \
	  mkdir ${PACKAGE_DISTROOT}/$$dir && cd ${PACKAGE_DISTROOT}/$$dir; \
	  for file in `cd ${abs_top_srcdir}/$$dir && echo *`; do \
	    if test -f ${abs_top_srcdir}/$$dir/$$file; then \
	      $(LN_S) ${abs_top_srcdir}/$$dir/$$file .; \
	    fi; \
	  done; \
	cd ${CURDIR}; done
	cd ${PACKAGE_DISTROOT}/src/pkginfo; $(LN_S) ${CURDIR}/$^ .
	tar chf - ${PACKAGE_DISTROOT} | gzip -c > ${PACKAGE_DISTNAME}-src.tar.gz
	rm -rf ${PACKAGE_DISTROOT}

# Workspace clean-up...
#
clean:
	rm -f *.$(OBJEXT) *.d *.dll pkginfo$(EXEEXT) mingw-get$(EXEEXT)

distclean: clean
	rm -f config.* version.c Makefile

maintainer-clean: distclean
	rm -f pkginfo.c *-$(PACKAGE_DISTVERSION)-*.tar.gz
	rm -rf ${PACKAGE_DISTROOT} staged

# $RCSfile: Makefile.in,v $: end of file
